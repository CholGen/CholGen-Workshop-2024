# O1 _Vibrio cholerae_ phylogenetic reconstruction

This is a walkthrough of a workflow to construction a phylogenetic tree of bacterial pathogen sequences generated by 
reference-based assembly.

# Contents
{:.no_toc}

1. Table of Contents
   {:toc}

## Description of workflows
The exercise will utilize workflows based on the bacpage bioinformatics pipeline.
The workflow itself is available on [Dockstore](https://dockstore.org/my-workflows/github.com/CholGen/bacpage/bacpage-phylogeny).
The source code for this workflow as well as bacpage is available on [GitHub](https://github.com/CholGen/bacpage/tree/master/bacpage/workflows/phylogeny.wdl)
This workflow is designed for execution on the [Terra](https://terra.bio) platform, but can also be run on other cloud 
platforms as well as on the command line using miniWDL.

Briefly, this tutorial will take you through the process of reconstructing a phylogeny from pathogen genome 
sequences, while masking problematic and recombination regions of the genome from the alignment.
The process comprises five main steps:
1. Aligning consensus sequences with each other and a background dataset.
2. Masking recombinant and user-specified regions from the alignment.
3. Performing phylogenetic inference.

%Insert workflow image of phylogeny%

## Terra workspace setup
This tutorial assumes you have run the workflows presented in and [Reference based assembly for O1 _Vibro cholerae_](workshop/bacpage-assemble.md).
It is also useful to have completed the [_Vibrio cholerae_ QC reports](workshop/report-bacpage-qcviz.md) tutorial to 
determine which of your samples are complete and high quality.
Specifically, this tutorial expects your workspace sample table to contain the following columns:
 - consensus_sequence

Check to make sure it is present.

You will also have to add two entries to your workspace data table.
To add values to your data table, navigate to the Data tab of your space workspace, click Workspace Data, and then 
click the blue plus (+) button in the lower right corner. A new row will be added to the table with a `Key`, `Value`,
and `Description` fields. Add the following two `String` entries to the table (`Description` can be left blank):

| Value         | Key                                         | Description |
|---------------|---------------------------------------------|-------------|
| o1_background | gs://bacpage-resources/o1_cholera_v2.vcf.gz |             |
| vc_mask       | gs://bacpage-resources/cholera_mask.gff     |             |


## Analysis walkthrough
From your workspace, click on the Workflows tab on the top. This should lead to a list of analysis workflows that have 
already been preloaded into your workspace. 
One of them is `bacpage-phylogeny`. 
Click on `bacpage-phylogeny`.
This will lead to a workflow launch page where you will need to set the parameters and inputs before launching your  
analyses.
Make sure to set the following:
- The `bacpage-phylogeny` "Version:" should be already set to `master`, but make sure it is set as such.
- "Run workflow(s) with inputs defined by data table" should be selected (not "file paths").
- "Step 1 -- Select data table:" should be set to `sample_set`.
- "Step 2 -- SELECT DATA" -- click on this button and a data selector box will pop up. At the top, make sure that 
  "Create a new sample_set from selected samples" is selected. We recommend selecting all samples that are  
  classified as `Vibrio cholerae` ("gambit_predicted_taxon" column), have coverage of at least 90% 
  ("percent_coverage" column), and have greater than 90% mapped reads ("percent mapped reads" column). The selected 
  samples will be saved as a new sample_set named "bacpage-phylogeny" + the current date and time. Change this to 
  something more informative that you will remember, and hit the OK button on the lower right of the pop up box. 
  This should return you to the workflow setup page which should now say that it will run on "1 sample_set 
  containing X samples" where X is the number of samples you selected.
- In the inputs table, we will need to populate the following required inputs:
  - `phylogeny_reconstruction.background_dataset` (required) should be set to `workspace.o1_background`
  - `phylogeny_reconstruction.consensus_sequences` (required) should be set to `this.samples.consensus_sequence`
  - `phylogeny_reconstruction.recombinant_mask` should be set to `workspace.vc_mask`
  - `phylogeny_reconstruction.outgroup` should be set to `Asia|IDN|ERR025382|UNK|1957`
- Click the SAVE button after you've set all the inputs. 

The resulting workflow launch page should look like this when you are ready:

%Add image of complete workflow launch page%

Click "RUN ANALYSIS" (which should be dark blue if you've filled in all inputs properly). 
This will take you to a job submission status page for your newly launched workflow, showing a single row in the 
bottom table corresponding to the job you submitted. 

## Wait for job completion
This workflow is quite computationally intensive and may take 4-6 hours to complete.
You will receive an email when each of your submissions complete (along with information about whether they succeeded or failed).
Additionally, you can also click on the JOB HISTORY tab at the top of your workspace to check on the status of your analyses in progress.
When both `bacpage-assemble` is complete, you can move on to viewing the results. 

## Evaluating results
You can examine the outputs and results of each step of each job via the Job History page, however, for large 
submissions, it is easier to view the saved top level outputs in the data table--in this case, the `sample_set` table. 
The `sample_set` table now has a number of additional output columns, including an alignment (VCF format), a sparse 
alignment, the recombinant regions identified (GFF format), and a phylogenetic tree (called `phylogeny.tree` and in 
[Newick](https://en.wikipedia.org/wiki/Newick_format) format). 

You can click on the live links for any file element in the Terra data table and download them, or preview them in
your browser. 
Click on the `phylogeny.tree` live link in the `phylogeny` column of the `bacpage-phylogeny-<date>-<time>` row of 
the `sample_set` table. 
This will open a "File Details" box where you can access this file three different ways:
1. Click the blue DOWNLOAD button to download it to your computer. 
2. If you have the gcloud API installed in a command line environment, copy and paste the `gsutil cp` command to
   your terminal, and it will download the file that way.
3. Click on "View this file in the Google Cloud Storage Browser".
    - This opens not the file, but its parent directory in a web browser for Google Cloud buckets. This directory will
      contain many other files, but look for the link to the file you were looking for originally (`phylogeny.tree`), and
      click that. This leads to an "Object details" page with information and several links for this particular file.
      Click the "Authenticated URL" link. This will download the report to your Downloads folder.

### Viewing the phylogeny
There are a variety of programs to visualize the phylogeny file, each with their own pros and cons.
1. [FigTree](https://github.com/rambaut/figtree/releases) is a popular tree visualization software that allows you 
   to arbitrarily color the nodes. However, this programs required you to download and install Java as well as the 
   program itself.
2. [Auspice](https://auspice.us/) is an online tree viewer which allows you to append arbitrary metadata by dragging and 
   dropping a CSV 
   file onto the web browser. You might be familiar with this viewer if you've ever used or made a Nextstrain tree 
   (Nextstrain is made on top of Auspice).
3. [Taxonium](https://taxonium.org/) is another online tree viewer which can accomodate much larger trees. You can 
   also color the tree with arbitrary metadata by dragging and dropping a CSV file onto the browser window.

## Other related resources
 - For the command line version of this same workflow see the [bacpage documentation](https://cholgen.github.io/sequencing-resources/phylogenetic-inference.html).
 - View the documentation and instructions for the different tree viewers:
   - [FigTree](https://www.youtube.com/watch?v=V6l1moUHsSc)
   - [Auspice](https://docs.nextstrain.org/projects/auspice/en/stable/)
   - [Taxonium](https://docs.taxonium.org/en/latest/)
